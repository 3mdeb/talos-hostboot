#!/bin/bash
#  IBM_PROLOG_BEGIN_TAG
#  This is an automatically generated prolog.
#
#  $Source: src/build/hwpf/prcd_compile_test $
#
#  IBM CONFIDENTIAL
#
#  COPYRIGHT International Business Machines Corp. 2011
#
#  p1
#
#  Object Code Only (OCO) source materials
#  Licensed Internal Code Source Materials
#  IBM HostBoot Licensed Internal Code
#
#  The source code for this program is not published or other-
#  wise divested of its trade secrets, irrespective of what has
#  been deposited with the U.S. Copyright Office.
#
#  Origin: 30
#
#  IBM_PROLOG_END

#Note that this test case assumes 2 files present in the PWD (along with prcd_compile.tcl)
# - fapiTestHwp.C and fapiTestHwp.H

BUILD="b1109a_2011_Sprint6"

###############################################################
# Validate return code, exit on failure
###############################################################
function check_good_rc {

    if [ $1 -eq 0 ]; then
        echo SUCCESS
        rm -f hbicore*
        rm -f hbotStringFile
        echo
    else
        echo FAIL; exit -1
    fi
}

###############################################################
# Validate return code is non-zero, exit on failure
###############################################################
function check_bad_rc {

    if [ $1 -ne 0 ]; then
        echo SUCCESS
        echo
    else
        echo FAIL; exit -1
    fi
}

###############################################################
# Main
###############################################################

# Check if the needed files exist, if not try and copy them in
if [ ! -f "./fapiTestHwp.H" ]; then
    cp ../../include/usr/hwpf/hwp/fapiTestHwp.H ./
    check_good_rc $?
fi

if [ ! -f "./fapiTestHwp.C" ]; then
    cp ../../usr/hwpf/hwp/fapiTestHwp.C ./
    check_good_rc $?
fi

if [ ! -f "./sample.initfile" ]; then
    cp ../../usr/hwpf/hwp/initfiles/sample.initfile ./
    check_good_rc $?
fi

echo 

echo "TEST - Good Path - Multi Process"
./prcd_compile.tcl -d $BUILD ./fapiTestHwp.H ./fapiTestHwp.C &
sleep 2
./prcd_compile.tcl -d $BUILD ./fapiTestHwp.H ./fapiTestHwp.C &
sleep 2
./prcd_compile.tcl -d $BUILD ./fapiTestHwp.H ./fapiTestHwp.C &
sleep 20

echo
echo "TEST - Good Path - 1 C File"
./prcd_compile.tcl -d $BUILD ./fapiTestHwp.C
check_good_rc $?

echo
echo "TEST - Good Path - 1 H File with -o Param"
./prcd_compile.tcl -d $BUILD -o ./ ./fapiTestHwp.H
check_good_rc $?

echo
echo "TEST - Good Path - 2 Files"
./prcd_compile.tcl -d $BUILD ./fapiTestHwp.H ./fapiTestHwp.C
check_good_rc $?

echo
echo "TEST - Good Path - Directory Path and Output Directory"
cp fapiTestHwp.H /tmp/
mkdir output
./prcd_compile.tcl -d $BUILD -o ./output/ /tmp/fapiTestHwp.H fapiTestHwp.C
check_good_rc $?
rm -rf output
rm /tmp/fapiTestHwp.H

echo
echo "TEST - Good Path - No Files"
./prcd_compile.tcl -d $BUILD
check_good_rc $?

echo
echo "TEST - Good Path - Initfile"
./prcd_compile.tcl -o ./output/ sample.initfile
check_good_rc $?
rm -rf ./output

echo
echo "TEST - Good Path - All Files"
./prcd_compile.tcl -o ./output/ sample.initfile fapiTestHwp.H ./fapiTestHwp.C
check_good_rc $?
rm -rf ./output

echo
echo "TEST - Bad Path - Compile Failure"
rm -f hbicore*; 
cp fapiTestHwp.H /tmp/
echo COMPILE_FAIL >> /tmp/fapiTestHwp.H
./prcd_compile.tcl -d $BUILD /tmp/fapiTestHwp.H fapiTestHwp.C
check_bad_rc $?
rm /tmp/fapiTestHwp.H
rm *.bin

