#!/usr/bin/perl
# IBM_PROLOG_BEGIN_TAG
# This is an automatically generated prolog.
#
# $Source: src/build/tools/addimgid $
#
# IBM CONFIDENTIAL
#
# COPYRIGHT International Business Machines Corp. 2011,2013
#
# p1
#
# Object Code Only (OCO) source materials
# Licensed Internal Code Source Materials
# IBM HostBoot Licensed Internal Code
#
# The source code for this program is not published or otherwise
# divested of its trade secrets, irrespective of what has been
# deposited with the U.S. Copyright Office.
#
# Origin: 30
#
# IBM_PROLOG_END_TAG

use strict;

my $imageIdSym = "hbi_ImageId";

my $img = shift;
my $src = shift;

my $imgBase = $img;
$imgBase =~ s/.*\///;

my $PREFIX = $ENV{'CROSS_PREFIX'};
my $address = hex `${PREFIX}nm $src -C | grep $imageIdSym | colrm 17`;
my $imageId = `git describe --dirty || echo Unknown-Image \`git rev-parse --short HEAD\``;

chomp $imageId;
$imageId = $imageId."/".$imgBase;

if (($imageId =~ m/Unknown-Image/) ||  	# Couldn't find git describe tag.
    ($imageId =~ m/dirty/) ||	 	# Find 'dirty' commit.
    ($imageId =~ m/^.{15}-[1-9]+/))	# Found commits after a tag.
{
    $imageId = $imageId."/".$ENV{"USER"};
}

system("echo -n $imageId | dd of=$img conv=notrunc bs=1 seek=$address count=127 >& /dev/null");
exit $?
